<!DOCTYPE html>
<html>
<head>
    <title>Final Database Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Final Database Test - Elma Operations Portal</h1>
    <div id="status"></div>
    
    <script>
        const SUPABASE_URL = "https://yltbknkksjgtexluhtau.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlsdGJrbmtrc2pndGV4bHVodGF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNjIyMTEsImV4cCI6MjA3NTkzODIxMX0.G0GWBtTKnoBv4XFS9MzIwkfx3CuxDiYH98JLc1GFqNA";
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        async function testDatabase() {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = '<p>Testing database setup...</p>';
            
            try {
                // Get current user
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                
                if (userError || !user) {
                    statusDiv.innerHTML = '<p class="error">Please log in first.</p>';
                    return;
                }
                
                statusDiv.innerHTML = '<p class="info">Current user found. Testing all database tables...</p>';
                
                // Test all required tables
                const tables = [
                    'profiles',
                    'user_management', 
                    'customers',
                    'sku_configurations',
                    'sales_transactions',
                    'factory_payables',
                    'transport_expenses',
                    'label_vendors',
                    'label_purchases',
                    'label_payments',
                    'orders',
                    'factory_pricing'
                ];
                
                let successCount = 0;
                let errorCount = 0;
                const results = [];
                
                for (const table of tables) {
                    try {
                        const { data, error } = await supabase
                            .from(table)
                            .select('*')
                            .limit(1);
                        
                        if (error) {
                            results.push(`‚ùå ${table}: ${error.message}`);
                            errorCount++;
                        } else {
                            results.push(`‚úÖ ${table}: Table accessible (${data ? data.length : 0} records)`);
                            successCount++;
                        }
                    } catch (err) {
                        results.push(`‚ùå ${table}: ${err.message}`);
                        errorCount++;
                    }
                }
                
                // Test specific functionality
                const functionalityTests = [];
                
                // Test factory_pricing table specifically
                try {
                    const { data: factoryData, error: factoryError } = await supabase
                        .from('factory_pricing')
                        .select('sku, price_per_case, pricing_date')
                        .limit(3);
                    
                    if (factoryError) {
                        functionalityTests.push(`‚ùå Factory Pricing: ${factoryError.message}`);
                    } else {
                        functionalityTests.push(`‚úÖ Factory Pricing: ${factoryData.length} records found`);
                        if (factoryData.length > 0) {
                            functionalityTests.push(`   Sample: ${factoryData[0].sku} - ‚Çπ${factoryData[0].price_per_case}`);
                        }
                    }
                } catch (err) {
                    functionalityTests.push(`‚ùå Factory Pricing: ${err.message}`);
                }
                
                // Test customers table
                try {
                    const { data: customerData, error: customerError } = await supabase
                        .from('customers')
                        .select('client_name, branch, sku, price_per_case')
                        .limit(3);
                    
                    if (customerError) {
                        functionalityTests.push(`‚ùå Customers: ${customerError.message}`);
                    } else {
                        functionalityTests.push(`‚úÖ Customers: ${customerData.length} records found`);
                        if (customerData.length > 0) {
                            functionalityTests.push(`   Sample: ${customerData[0].client_name} - ${customerData[0].branch}`);
                        }
                    }
                } catch (err) {
                    functionalityTests.push(`‚ùå Customers: ${err.message}`);
                }
                
                // Display results
                statusDiv.innerHTML = `
                    <div class="section">
                        <h3>Database Table Tests</h3>
                        <p><strong>Success:</strong> ${successCount} tables | <strong>Errors:</strong> ${errorCount} tables</p>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0;">
                            ${results.map(result => `<p>${result}</p>`).join('')}
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>Functionality Tests</h3>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0;">
                            ${functionalityTests.map(test => `<p>${test}</p>`).join('')}
                        </div>
                    </div>
                `;
                
                if (errorCount === 0) {
                    statusDiv.innerHTML += `
                        <div class="section" style="background: #d4edda; border-color: #c3e6cb;">
                            <h3 class="success">üéâ SUCCESS! All Database Tables Are Working!</h3>
                            <p>Your Elma Operations Portal is now fully functional.</p>
                            <p><strong>What's Working:</strong></p>
                            <ul>
                                <li>‚úÖ All 12 database tables are accessible</li>
                                <li>‚úÖ Factory pricing data is properly structured</li>
                                <li>‚úÖ Customer data is available</li>
                                <li>‚úÖ RLS policies are active</li>
                                <li>‚úÖ Sample data is loaded</li>
                            </ul>
                            <p><strong>Next Steps:</strong></p>
                            <ol>
                                <li>Go to <a href="http://localhost:8081" target="_blank">http://localhost:8081</a></li>
                                <li>Test all features in the application</li>
                                <li>Verify that no 404 errors occur</li>
                                <li>Start using the application for your business operations</li>
                            </ol>
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML += `
                        <div class="section" style="background: #f8d7da; border-color: #f5c6cb;">
                            <h3 class="error">‚ö†Ô∏è Some Issues Found</h3>
                            <p>Please run the <code>complete_database_fix_final.sql</code> script in Supabase Dashboard:</p>
                            <ol>
                                <li>Go to Supabase Dashboard ‚Üí SQL Editor</li>
                                <li>Run the contents of <code>complete_database_fix_final.sql</code></li>
                                <li>Refresh this page to test again</li>
                            </ol>
                        </div>
                    `;
                }
                
            } catch (err) {
                statusDiv.innerHTML = `<p class="error">Error: ${err.message}</p>`;
            }
        }
        
        // Auto-test when page loads
        testDatabase();
    </script>
</body>
</html>






