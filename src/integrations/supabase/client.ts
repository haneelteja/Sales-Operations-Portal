// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

// Use environment variables for configuration (no hardcoded fallbacks for production)
const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL ?? '';
const SUPABASE_PUBLISHABLE_KEY = import.meta.env.VITE_SUPABASE_ANON_KEY ?? '';

// Clear cached auth from any previous Supabase project to avoid mixing sessions
if (typeof window !== 'undefined') {
  localStorage.removeItem('supabase.auth.token');
  localStorage.removeItem('supabase.auth.refresh_token');
  ['yltbknkksjgtexluhtau', 'qkvmdrtfhpcvwvqjuyuu', 'ksfkgzlwgvwijjkaoaqq'].forEach((ref) => {
    localStorage.removeItem(`sb-${ref}-auth-token`);
    localStorage.removeItem(`sb-${ref}-auth-refresh-token`);
  });
}

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, {
  auth: {
    storage: localStorage,
    persistSession: true,
    autoRefreshToken: true,
  },
  // Add better error handling
  global: {
    headers: {
      'x-client-info': 'aamodha-operations-portal'
    },
    fetch: async (url, options = {}) => {
      try {
        const response = await fetch(url, {
          ...options,
          // Add timeout
          signal: AbortSignal.timeout(30000), // 30 second timeout
        });
        return response;
      } catch (error: unknown) {
        // Enhanced error logging
        const errorObj = error as { message?: string; name?: string; cause?: unknown };
        console.error('Supabase fetch error:', {
          url,
          error: errorObj.message,
          type: errorObj.name,
          cause: errorObj.cause
        });
        
        // If it's a network error, provide helpful message
        if (errorObj.name === 'AbortError' || errorObj.message?.includes('Failed to fetch')) {
          throw new Error('Network error: Unable to connect to Supabase. Please check your internet connection and try again.');
        }
        
        throw error;
      }
    }
  }
});

// Helper function to handle Supabase errors with better messages
export const handleSupabaseError = (error: unknown): string => {
  if (!error) return 'An unknown error occurred';
  
  const errorObj = error as { message?: string; name?: string; code?: string };
  
  // Handle network/fetch errors
  if (errorObj.message?.includes('Failed to fetch') || 
      errorObj.message?.includes('Network error') ||
      errorObj.message?.includes('network') ||
      errorObj.name === 'TypeError') {
    return 'Network error: Unable to connect to Supabase. Please check your internet connection and try again. If the problem persists, the Supabase service may be temporarily unavailable.';
  }
  
  // Handle timeout errors
  if (errorObj.message?.includes('timeout') || errorObj.name === 'AbortError') {
    return 'Request timeout: The server took too long to respond. Please try again.';
  }
  
  // Handle network/SSL errors
  if (errorObj.message?.includes('ERR_CERT_AUTHORITY_INVALID') || 
      errorObj.message?.includes('certificate') ||
      errorObj.message?.includes('SSL')) {
    return 'SSL certificate error. Please check your network connection or contact support.';
  }
  
  // Handle 400 Bad Request errors
  if (errorObj.code === 'PGRST116' || errorObj.message?.includes('400')) {
    return 'Invalid request. Please check your query parameters and try again.';
  }
  
  // Handle RLS (Row Level Security) errors
  if (errorObj.code === '42501' || errorObj.message?.includes('permission') || errorObj.message?.includes('RLS')) {
    return 'Permission denied. Please check your access rights.';
  }
  
  // Return the error message if available
  return errorObj.message || 'An error occurred while processing your request';
};